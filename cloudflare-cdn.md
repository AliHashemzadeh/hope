# استفاده از روش CloudFlare CDN

در این روش از یک تکنیک ساده استفاده می‌کنیم تا احتمال شناسایی سرور ما کمتر بشود. در حالت عادی بین دستگاه موبایل و سروری که راه‌اندازی کردید یک ارتباط مستقیم برقرار می‌شود. بدین صورت که دستگاه شما به پروکسی سرور اعلام می‌کند که قصد استفاده از چه سرویسی را دارد. بعد هم پروکسی سرور در نقش یک «واسط» با اتصال به آن سرویس، امکان این را فراهم می‌کند که بین گوشی و سرویس مقصد ارتباط برقرار شود. 

![image](https://user-images.githubusercontent.com/118040490/212413099-0d01cfb5-83cf-4873-b72d-28ed58e199ae.png)


گاهی به این روش ایرادی گرفته می‌شود و آن هم این است که اتصال مستقیم از داخل شبکه ایران به شبکه‌ای در خارج از کشور باعث لو رفتن IP سرور می‌شود و شانس مسدود شدن سرور بالا خواهد رفت.

برای رفع این نقص پیشنهاد می‌شود به جای اتصال مستقیم به سرور از یک واسط استفاده کنیم که در شبکه اینترنت ایران به عنوان واسطی معتمد شناخته می‌شود. اسم این واسط هم چیزی نیست جز شرکت معروف [Cloudflare](). با روش جدید، نمودار به شکل زیر تغییر خواهد کرد. می‌بینید که به جای اتصال مستقیم کلاینت به CloudFlare متصل می‌شود و از آنجا به پروکسی سرور متصل خواهیم شد. مزیت این روش این هست که فیلترچی هیچ‌وقت نخواهد فهمید که آدرس پروکسی سرور ما چی هست. تنها چیزی که خواهد دید برقراری اتصال بین دستگاهی در داخل با CloudFlare است.  

![image](https://user-images.githubusercontent.com/118040490/212414604-056e701c-936e-4db9-92e2-275e6ab3e845.png)


## پیش‌نیاز‌های استفاده از CDN
استفاده از روش CDN پیش‌نیاز‌هایی دارد:

۱. نیاز به ساخت یک [حساب در CloudFlare](https://dash.cloudflare.com/sign-up) دارید.  

۲. نیاز به domian داریم. شرکت‌هایی مثل GoDaddy، Namecheap و یا CloudFlare به شما کمک می‌کنند یک دامنه شخصی تهیه کنید. در خرید دامنه توجه کنید که استفاده از پسوند‌های معروف‌تر مثل com یا net و یا org احتمال فیلتر شدن دامنه را کاهش می‌دهد.

۳. دامنه شما باید توسط nameserver های CloudFlare مدیریت شود. اگر دامنه را از Cloudflare تهیه کرده‌اید این‌کار به طور خود‌کار برای شما انجام می‌شود و نیاز به تغییر نیست. اگر دامنه را از ارائه‌دهنده‌ دیگری گرفته‌اید، لازم هست تا nameserver های دامنه را به آدرس‌‌های Cloudflare تغییر دهید. در گوگل پیدا کنید که چطور می‌توانید nameserver را تغییر دهید، با توجه به شرکت ارائه دهنده فرایند متفاوتی را باید طی کنید.  

۴. پروتکل پروکسی باید استفاده از WebSocket و یا WS را پشتیبانی بکند. در حال حاضر فقط VMESS و VLESS استفاده از WS را پشتیبانی می‌کنند. پیشنهاد ما فقط استفاده از VLESS می‌باشد. در نتیجه Trojan نمی‌تواند برای این روش استفاده شود.

۵. پلن رایگان CloudFlare اجازه انتقال ترافیک روی پورت‌های محدود و مشخصی را می‌دهد. در نتیجه از هر پورتی نمی‌توانید استفاده کنید. اگر از TLS استفاده می‌کنید باید کانفیگ را بر روی یکی از پورت‌های HTTPS تعریف کرده باشید. در غیر‌این‌ صورت فقط از پورت‌های HTTP می‌توانید استفاده کنید. برای اطلاعات بیشتر به [مستند CloudFlare](https://developers.cloudflare.com/fundamentals/get-started/reference/network-ports/) رجوع کنید. جدول زیر پورت‌های مجاز را فهرست کرده است.

![image](https://user-images.githubusercontent.com/118040490/212417661-6c82e3fe-889b-47ef-9f46-aa6b08ac9849.png)

# روش اول: حقه پروکسی

### گام اول

در پنل CloudFlare گزینه Websites رو بزنید و domain رو از سمت راست انتخاب کنید. اگر دامنه را نمی‌بینید، گزینه Add a Site رو بزنید و دامنه را اضافه کنید.

![image](https://user-images.githubusercontent.com/118040490/212424353-8777399d-2fa4-44a4-8229-5fb53ec6b86f.png)

## گام دوم

حالا گزینه DNS رو انتخاب کنید. اگر عکس واضح نیست بر روی آن کلیک کنید.

![image](https://user-images.githubusercontent.com/118040490/212427170-8dbc1fa0-9c09-473a-979b-5b50bec93a3a.png)

مطابق تصویر یک رکورد جدید بسازید. نام را هر چه دوست دارید انتخاب کنید. در قسمت IPv4 باید آدرس IP سرور خودتان را انتخاب کنید. گزینه Proxy هم باید فعال باشد. دیگه کاری با CloudFlare نداریم. تمام!

## گام سوم
می‌توانید از این گام عبور کنید. این گام فقط وقتی ضروری هست که بخواهید از TLS استفاده کنید.

لازم هست برای sub-domain جدیدی که ایجاد کردیم یک certificate معتبر بسازیم. مثلا در تصویر قبلی دامنه ما iranxray.com بود و زیر-دامنه‌ای که ساختیم cdn.iranxray.com می‌باشد. پس در این مثال باید برای cdn.iranxray.com یک certificate معتبر ایجاد کنیم. در [مستند تهیه certificate](https://github.com/iranxray/hope/blob/main/create-tsl-certificate.md) گام‌های لازم را توضیح داده‌ایم.

## گام چهارم
حالا نوبت به ساخت کانفیگ VLESS می‌رسد. اگر می‌خواهید از TLS استفاده نکنید، باید کانفیگی مطابق تصویر زیر بسازید. دقت کنید که به جای cdn.iranxray شما باید آدرس زیر-‌دامنه‌ خودتان را وارد کنید. ما پورت 80 را انتخاب کردیم اما شما می‌توانید هر پورت دیگری که CloudFlare برای HTTP استفاده می‌کند هم مشخص کنید.

![image](https://user-images.githubusercontent.com/118040490/212429749-e7df7a32-fa43-4fb8-acef-be33304a0f39.png)

اگر می‌خواهید از TLS استفاده کنید، صرفا کافی است گزینه TLS را فعال کنید. همچنین باید پورتی را انتخاب کنید که بر روی HTTPS‌ پشتیبانی می‌شود مانند ۴۴۳.

![image](https://user-images.githubusercontent.com/118040490/212430584-5b3413f9-c976-4d5a-a578-4479826df8eb.png)



# روش دوم: حقه header
