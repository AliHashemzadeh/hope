# ساخت TLS Certificate

برای اینکه کاربران ما نسبت به ایمنی داده‌های‌شان در برابر دیواره GFW‌ مطمئن باشند، ما می‌بایست داده‌های شان را با پروتکل‌های TLS و یا XTLS رمزنگاری کنیم. برای این رمزنگاری ما نیاز خواهیم داشت که بر روی سرور لینوکسی خود کلیدهای رمزنگاری یا certificate داشته باشیم. در این مستند شرح خواهیم داد که این کلیدها چگونه ساخته خواهند شد.

برای ساخت کلید رمزنگاری دو روش `Self-Signed` و `Let's Encrypt` را شرح خواهیم داد. فکر می‌کنیم برای کاربران عادی، استفاده از روش Self-Signed راحت‌‌تر می‌باشد. استفاده از روش Let's Encrypt‌ نیاز به خرید domain دارد که هزینه‌ای حدود سالی ۱۰ دلار خواهد داشت اما در عوض امنیت بیشتری را برای کاربران‌تون فراهم خواهد کرد.


# ساخت کلید رمزنگاری به روش Self-Signed (برای کاربران مبتدی)

این روش برای کسانی مناسب هست که برای اولین‌بار می‌خواهند فیلترشکن را راه‌اندازی کنند و یا خیلی از کامپیوتر سررشته ندارند. شما این مرحله رو فقط یکبار لازم هست که انجام بدهید. شروع می‌کنیم.

## گام اول

با دستور زیر، سطح اختیارات را بالا می‌بریم.

```bash
sudo -i
```

## گام دوم

با دستور زیر، بانک اطلاعاتی اپلیکیشن‌های لینوکس را به روز می‌کنیم.



```bash
apt update && apt upgrade -y
```

## گام سوم
با دستور زیر، openssl را نصب می‌کنیم.


```bash
sudo apt-get install openssl
```

## گام چهارم
با دستور زیر، کلیدهای رمزنگاری را بر روی سیستم تعریف می‌کنیم. دستور زیر دو فایل به نام private.key و cert.pem بر روی سرور شما ایجاد می‌کند.


```bash
openssl req -x509 -newkey rsa:4096 -keyout private.key -out cert.pem -sha256 -days 365 -nodes
```

## گام پنجم
دستور قبلی، سوال‌هایی را از شما می‌پرسد. نیازی به پاسخ دادن هیچ کدام از سوال‌ها نیست مگر برای سوال Common Name که نام دامنه را از شما می‌پرسد.

![image](https://user-images.githubusercontent.com/118040490/201593200-90fc980c-102b-4620-b922-21f7bea72ffe.png)

در تصویر فوق مشاهده می‌کنید که ما از دامنه فرضی iranxray.hope.com استفاده کرده ایم. شما می‌توانید هر نام دلخواهی را استفاده کنید.  این دامنه را یادداشت کنید، چون در حین ساخت VLESS و Trojan به آن نیاز خواهیم داشت.

## گام ششم
با دستور زیر، به X-UI دسترسی خواهیم داد که فایل‌های ساخته شده برای رمزنگاری استفاده کند.

```bash
chmod ugo+rwx cert.pem
chmod ugo+rwx private.key
```


## گام هفتم

حال دو فایل بر روی سیستم شما ساخته شده. برای گرفتن آدرس کامل فایل‌ certificate دستور زیر را وارد کنید. نتیجه را یادداشت نمایید چون باید این آدرس را باید در X-UI وارد نمایید.


```bash
echo "$(pwd)/cert.pem"
```

و برای گرفتن آدرس کامل کلید خصوصی دستور زیر را وارد کنید. نتیجه را یادداشت نمایید چون باید این آدرس را باید در X-UI وارد نمایید


```bash
echo "$(pwd)/private.key"
```

## گام هشتم
تمام. برای راه‌اندازی پروتکل‌های VLESS و Trojan به دامنه و آدرس فایل‌هایی که در مراحل قبل یادداشت کردید، نیاز خواهیم داشت. ادامه را از [مقاله ساخت کانفیگ](https://github.com/iranxray/hope/blob/main/create-configs.md) دنبال کنید

# ساخت کلید رمزنگاری معتبر با استفاده از Let's Encrypt (برای کاربران خفن!)

طی این مرحله اجباری نیست. اگر Self-Signed را ساخته‌اید، می‌توانید از اینجا گذر کنید. این مرحله حکم پرتاب سه امتیازی دارد. گرفتن کلید رمزنگاری معتبر از Let's Encrypt نیاز به خرید domain واقعی و انجام برخی تنظیمات دارد که برای کاربرهای مبتدی‌ دشوار می‌باشد اما در عوض امنیت بیشتری را برای کاربران‌تان فراهم خواهد کرد.

## گام صفر

برای ساخت certificate با Let's Encrypt نیاز به یک domain واقعی دارید. می توانید از شرکت‌هایی مثل [GoDaddy](https://www.godaddy.com/) یا [Namecheap](https://www.namecheap.com/) برای خرید domain‌ استفاده کنید. هیچ فرقی ندارد که دامنه شما com. باشد یا net.‌و یا هر چیز دیگر. هر کدام ارزان‌‌تر بود بخرید. بعد از خرید دامنه باید با اعمال تغییرات در DNS کاری کنید که دامنه شما به آدرس IP سرور شما متصل شده باشد.

## گام اول

پیش از طی مراحل بعدی، اطمینان حاصل کنید که پورت 80 بر روی سرور لینوکسی شما باز می‌باشد. برای باز کردن پورت می‌توانید به [مقاله ما در مورد باز کردن پورت](https://github.com/iranxray/hope/blob/main/open-server-port.md) رجوع کنید تا پورت 80 را باز کنید. اپلیکیشن certbot نیاز دارد تا اطلاعات کلید را از روی پورت 80 دریافت کند.

## گام دوم
ابتدا با دستور زیر، سطح اختیارات را بالا می‌بریم.

```bash
sudo -i
```

## گام سوم

با دستور زیر، بانک اطلاعاتی اپلیکیشن‌های لینوکس را به روز می‌کنیم.



```bash
apt update && apt upgrade -y
```

## گام چهارم
حالا certbot را نصب می‌کنیم تا بتوانیم به لطف پروژه Let's Encrypt کلیدهای معتبر TLS بسازیم.


```bash
sudo apt-get install certbot
```

## گام پنجم
بعد از نصب، دستور زیر را اجرا کنید تا کلیدهای رمزنگاری بر روی سیستم شما ساخته شود. در دستور پایین، از ایمیل فرضی test@email.com و دامنه فرضی iran-free-xray.com  استفاده کرده‌ایم. شما باید این مقادیر را تغییر دهید و نام دامنه‌ای که انتخاب می‌کنید باید مطابق با دامنه‌ای باشد که خریداری کرده‌اید. 


:star:
دقت کنید که NameServer ها بایستی به آدرس IP سیستم شما اشاره کنند وگرنه نمی‌توانید certificate را صادر کنید.

```bash
sudo certbot certonly --standalone --preferred-challenges http --agree-tos --email test@email.com -d iran-free-xray.com 
```

در حین صدور certificate، سوال زیر در مورد اشتراک گذاری اطلاعات پرسیده می‌شود. می توانید `N` را وارد کنید تا اطلاعات شما محفوظ بماند.

![image](https://user-images.githubusercontent.com/118040490/203454799-c59a865a-1709-4a02-81c8-b88b5c80043a.png)


:star:
اگر با خطای زیر مواجه شدید، احتمالا به این خاطر هست که پورت `80‍` را باز نکرده‌اید. برای باز کردن پورت می‌توانید به [مقاله ما در مورد باز کردن پورت](https://github.com/iranxray/hope/blob/main/open-server-port.md) رجوع کنید تا پورت `80` را باز کنید.

![image](https://user-images.githubusercontent.com/118040490/203455215-4a723a64-4616-4803-b013-fbde0271414a.png)

## گام ششم

اگر همه چیز خوب پیش رفته باشد، باید پیغامی شبیه زیر دریافت کنید. همانطور که در عکس می‌بینید، آدرس فایل‌هایی certificate به شما نشان داده شده‌اند. این مقادیر را کپی کنید و دم دست داشته باشید. ما به آدرس این فایل‌ها نیاز خواهیم داشت تا بتوانیم `Trojan` و یا `VLESS+XTLS` را بسازیم. 

![image](https://user-images.githubusercontent.com/118040490/203455773-bd35cb28-49ec-436b-86e3-0be91803eb41.png)

با توجه به عکس پایین، فقط یادتان باشد که آدرس فایل `fullchain.pem` را در باکس اول و آدرس `privatekey.pem` را در باکس دوم می‌گذاریم.

![image](https://user-images.githubusercontent.com/118040490/203456520-98ff4636-0690-4916-8ecf-5b631012a921.png)

## گام هفتم
از این لحظه به بعد، برای باز کردن پورتال در مرورگر به جای استفاده از `http://ip:port` باید از دامنه برای باز کردن پورتال استفاده کنید. مثلا اگه دامنه شما iran-free-xray.com باشد و از پورت 34567‌استفاده می‌کنید، باید از این به بعد از آدرس `http://iran-free-xray.com:34567` استفاده کنید.

![image](https://user-images.githubusercontent.com/118040490/203457457-0bb9bc53-855c-4d13-a2f4-292977781ef9.png)

تمام. از آدرس دامنه استفاده کنید تا به پورتال بروید و ادامه را از [مقاله ساخت کانفیگ](https://github.com/iranxray/hope/blob/main/create-configs.md) دنبال کنید. 


